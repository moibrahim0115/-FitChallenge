<meta name="description" content="A 30-day global fitness challenge - Rebuild">
<meta name="keywords" content="fitness, challenge, workout, exercise, 30-day">
<meta name="author" content="Mohamed Ibrahim">

<title>FitChallenge - 30 Day Challenge</title>

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Basic CSS -->
<style>
    :root {
        /* Colors */
        --primary: #FF4B2B;
        --primary-light: #FFEBE7;
        --secondary: #FF416C;
        --tertiary: #FFC107;
        --white: #FFFFFF;
        --black: #000000;
        --text-primary: #333333;
        --text-secondary: #666666;
        --text-tertiary: #999999;
        --bg-light: #f8f9fa;
        --background-dark: #1E293B;
        --input-background: #F9FAFB;
        --input-border: #E2E8F0;
        --success: #10B981;
        --success-light: #D1FAE5;
        --danger: #EF4444;
        --warning: #F59E0B;
        --info: #3B82F6;
        
        /* Gradients */
        --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        --gradient-sport: linear-gradient(135deg, #FF4B2B 0%, #FF416C 100%);
        --gradient-achievement: linear-gradient(135deg, #FFA500 0%, #FFCC80 100%);
        
        /* Spacing */
        --spacing-1: 0.25rem;  /* 4px */
        --spacing-2: 0.5rem;   /* 8px */
        --spacing-3: 0.75rem;  /* 12px */
        --spacing-4: 1rem;     /* 16px */
        --spacing-5: 1.5rem;   /* 24px */
        --spacing-6: 2rem;     /* 32px */
        --spacing-7: 2.5rem;   /* 40px */
        --spacing-8: 3rem;     /* 48px */
        --spacing-9: 3.5rem;   /* 56px */
        --spacing-10: 4rem;    /* 64px */
        
        /* Font Sizes */
        --font-size-xs: 0.75rem;    /* 12px */
        --font-size-sm: 0.875rem;   /* 14px */
        --font-size-base: 1rem;     /* 16px */
        --font-size-lg: 1.125rem;   /* 18px */
        --font-size-xl: 1.25rem;    /* 20px */
        --font-size-2xl: 1.5rem;    /* 24px */
        --font-size-3xl: 1.875rem;  /* 30px */
        --font-size-4xl: 2.25rem;   /* 36px */
        
        /* Border Radius */
        --border-radius: 0.375rem;    /* 6px */
        --border-radius-lg: 0.5rem;   /* 8px */
        --border-radius-xl: 0.75rem;  /* 12px */
        --border-radius-2xl: 1rem;    /* 16px */
        --border-radius-full: 9999px; /* Full Rounded */
        
        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        
        /* Transitions */
        --transition-normal: all 0.3s ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html {
        scroll-behavior: smooth;
        font-size: 16px; /* Base font size */
    }

    body {
        font-family: 'Poppins', sans-serif;
        line-height: 1.6;
        color: var(--text-primary);
        background-color: var(--background);
        overflow-x: hidden; /* Prevent horizontal scroll */
    }

    .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 var(--spacing-4);
    }

    /* Header Styles */
    .header {
        background: linear-gradient(to right, var(--primary) 0%, var(--secondary) 100%);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        padding: var(--spacing-3) 0;
        transition: all 0.3s ease;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 var(--spacing-4);
    }
    
    .header-action-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        border-radius: var(--border-radius-full);
        padding: 6px 12px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .header-action-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }
    
    .header-action-btn i {
        font-size: 1.1em;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--white);
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .logo:hover {
        transform: scale(1.05);
    }

    .logo i {
        font-size: 1.5em;
        transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    .logo:hover i {
        transform: rotate(360deg);
    }

    .logo span {
        color: var(--white);
    }

    /* Main Content Styles */
    .main {
        padding-top: 80px; /* Adjusted for fixed header height */
        padding-bottom: var(--spacing-8);
    }

    .challenge-container {
        background: var(--white);
        border-radius: var(--border-radius-xl);
        padding: var(--spacing-6);
        box-shadow: var(--shadow-lg);
        margin-top: var(--spacing-6);
    }

    .section-title {
        text-align: center;
        margin-bottom: var(--spacing-6);
        color: var(--text-primary);
        font-size: var(--font-size-2xl);
        font-weight: 700;
    }

    /* Progress Bar Enhancements */
    .progress-container {
        margin-bottom: var(--spacing-6);
        padding: var(--spacing-4);
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--border-radius-lg);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(226, 232, 240, 0.7);
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-2);
        font-weight: 600;
    }

    .progress-bar {
        height: 12px;
        background: #edf2f7;
        border-radius: var(--border-radius-full);
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: var(--border-radius-full);
        width: 0%;
        position: relative;
        transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 2px 5px rgba(255, 75, 43, 0.3);
    }

    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.1) 0%,
            rgba(255, 255, 255, 0.3) 50%,
            rgba(255, 255, 255, 0.1) 100%
        );
        animation: shineEffect 2s infinite linear;
        transform: skewX(25deg);
    }

    @keyframes shineEffect {
        0% { transform: translateX(-100%) skewX(25deg); }
        100% { transform: translateX(100%) skewX(25deg); }
    }

    #progress-percentage {
        color: var(--black);
        font-weight: 700;
        transition: all 0.3s ease;
    }

    /* Stats Container Styles */
    .stats-container {
        display: grid;
        /* Adjusted grid to better fit two items, or one on small screens */
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-4);
        margin-bottom: var(--spacing-6);
    }

    .stat-card {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-4);
        text-align: center;
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
        border: 1px solid #eee; /* Subtle border */
        cursor: default; /* Not clickable */
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .stat-icon {
        font-size: 1.8rem;
        margin-bottom: var(--spacing-3);
        color: var(--primary);
        transition: transform 0.3s ease;
    }

    .stat-card:hover .stat-icon {
         /* No rotation needed */
    }

    .stat-title {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-1);
        font-weight: 500;
    }

    .stat-value {
        font-size: 2rem; /* Slightly smaller */
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--spacing-1);
        animation: none; /* Remove pulse animation */
    }

    .stat-description {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
    }

    /* Calendar Styles */
    .calendar {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-5);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-6);
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-4);
    }

    .month-nav {
        background: none;
        border: none;
        font-size: var(--font-size-lg);
        color: var(--text-primary);
        cursor: pointer;
        padding: var(--spacing-2);
        width: 40px; /* Fixed size */
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius-full);
        transition: all 0.3s ease;
    }

    .month-nav:hover {
        background: var(--gradient-sport);
        color: var(--white);
    }

    .current-month {
        font-size: var(--font-size-lg);
        font-weight: 600;
        text-align: center; /* Center month text */
    }

    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: var(--spacing-2);
        margin-bottom: var(--spacing-3);
        text-align: center;
    }

    .weekday {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
    }

    .calendar-dates {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: var(--spacing-2);
    }

    .date-cell {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column; /* Stack number and checkmark */
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius-lg); /* Softer corners */
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        font-size: var(--font-size-base);
        font-weight: 500;
        border: 1px solid transparent; /* Placeholder for hover/current */
        background-color: #f8f9fa; /* Light background for dates */
    }

    .date-cell.empty {
        background-color: transparent;
        cursor: default;
        pointer-events: none; /* Make empty cells unclickable */
    }

    .date-cell:not(.empty):hover {
        background: var(--gradient-sport);
        color: var(--white);
        transform: scale(1.05); /* Subtle scale */
        box-shadow: var(--shadow-sport);
        z-index: 1;
        border-color: transparent;
    }

    .date-cell.completed {
        background: var(--gradient-achievement);
        color: var(--white);
        font-weight: 600;
    }

    .date-cell.current-day {
        border: 2px solid var(--primary);
        font-weight: 700;
        color: var(--primary);
    }

    .date-cell.completed.current-day {
         /* Ensure completed current day overrides border color */
         border-color: transparent;
    }

    /* Position checkmark at bottom left */
    .date-cell .date-status {
        position: absolute;
        bottom: 4px;
        left: 4px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        color: white; /* Better visibility */
        background-color: rgba(220, 53, 69, 0.95); /* Rojo más oscuro */
        display: none; /* إخفاء علامة الصح بشكل افتراضي - Ocultar por defecto */
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        z-index: 5;
    }
    
    /* إظهار علامة الصح فقط في الأيام المكتملة - Mostrar solo en días de ejercicio en casa */
    .date-cell.completed:not(.gym-day) .date-status {
        display: flex;
        animation: checkmark 0.4s ease-out;
    }
    
    /* Ocultar la marca de verificación en los días de gimnasio */
    .date-cell.gym-day .date-status {
        display: none !important;
    }

    @keyframes checkmark {
        0% { transform: scale(0); opacity: 0; }
        70% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--modal-background);
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        z-index: 1010; /* Above header */
        opacity: 0;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding: var(--spacing-4); /* Padding for smaller screens */
    }

    .modal-overlay.active {
        display: flex; /* Show when active */
        opacity: 1;
    }

    .modal {
        background: var(--white);
        border-radius: var(--border-radius-xl);
        padding: var(--spacing-6);
        width: 100%;
        max-width: 550px; /* Consistent max width */
        position: relative;
        transform: scale(0.95);
        opacity: 0;
        transition: all 0.3s ease-out;
        box-shadow: var(--shadow-xl);
        max-height: 90vh; /* Prevent modal overflow */
        overflow-y: auto; /* Allow scrolling if content overflows */
    }

    .modal-overlay.active .modal {
        transform: scale(1);
        opacity: 1;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* Align items to top */
        margin-bottom: var(--spacing-4);
        padding-bottom: var(--spacing-4);
        border-bottom: 1px solid #eee; /* Separator */
    }

    .modal-title-container {
         flex-grow: 1; /* Allow title container to take space */
    }

    .modal-title {
        font-size: var(--font-size-xl);
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-1);
    }

    .modal-subtitle {
        font-size: var(--font-size-base);
        color: var(--text-secondary);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
        transition: color 0.3s ease;
        padding: var(--spacing-1); /* Easier to click */
        line-height: 1; /* Prevent extra space */
        margin-left: var(--spacing-4); /* Space from title */
    }

    .modal-close:hover {
        color: var(--danger);
    }

    .modal-content {
         margin-bottom: var(--spacing-6);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end; /* Align buttons to the right */
        gap: var(--spacing-3);
        padding-top: var(--spacing-4);
        border-top: 1px solid #eee; /* Separator */
    }

    /* Day Modal Specific Styles */
    .workout-info {
        margin: var(--spacing-4) 0;
    }

    .workout-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-2);
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-4);
    }

    .workout-title i {
        color: var(--primary);
    }

    .workout-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-3);
    }

    /* Style for exercise items */
    .exercise-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        border-radius: var(--border-radius-lg);
        background-color: var(--bg-light);
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .exercise-item:hover {
        background-color: #f1f5f9;
        transform: translateY(-2px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.08);
    }

    .exercise-item.completed {
        background-color: #f0fff4;
        border: 1px solid #c6f6d5;
    }

    .exercise-icon {
        background-color: var(--primary-light);
        color: var(--primary);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 0.9rem;
    }

    .exercise-details {
        flex: 1;
    }

    .exercise-name {
        font-weight: 600;
        margin-bottom: 2px;
    }

    .exercise-reps {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .exercise-check {
        color: var(--success);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .exercise-item.completed .exercise-check {
        opacity: 1;
    }

    .exercise-item.completed .exercise-icon {
        background-color: var(--success-light);
        color: var(--success);
    }

    /* Achievement Modal Styles */
    .achievement-modal .modal-header {
         border-bottom: none; /* Remove border for achievement modal header */
         text-align: center;
         flex-direction: column; /* Stack icon and title */
         align-items: center;
    }

     .achievement-modal .modal-title {
         display: flex;
         align-items: center;
         gap: var(--spacing-2);
         margin-top: var(--spacing-2);
         font-size: 1.6rem; /* Larger title */
     }

    .trophy-icon {
        font-size: 3rem;
        color: var(--tertiary);
        margin-bottom: var(--spacing-2);
        display: block; /* Center icon */
        margin-left: auto;
        margin-right: auto;
        animation: trophyGlow 1.5s infinite alternate ease-in-out;
    }

    @keyframes trophyGlow {
        from { text-shadow: 0 0 8px rgba(255, 215, 0, 0.4); transform: scale(1); }
        to { text-shadow: 0 0 20px rgba(255, 215, 0, 0.8); transform: scale(1.05); }
    }

    .achievement-content {
         text-align: center;
    }

    .achievement-badge {
        background: var(--gradient-achievement);
        color: var(--text-primary); /* Darker text for better contrast on gold */
        padding: var(--spacing-2) var(--spacing-5);
        border-radius: var(--border-radius-full);
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-2);
        margin: var(--spacing-4) 0;
        box-shadow: var(--shadow-achievement);
        font-weight: 600;
        animation: badgePop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s backwards;
    }

     .achievement-badge i {
        font-size: 1.2em;
     }

    @keyframes badgePop {
        0% { transform: scale(0); opacity: 0; }
        70% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
    }

    .achievement-message {
        font-size: var(--font-size-lg);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-6);
    }

    .achievement-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: var(--spacing-4);
        margin: var(--spacing-6) 0;
        padding: var(--spacing-5);
        background-color: #f8f9fa;
        border-radius: var(--border-radius-lg);
    }

    .achievement-stats .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-2);
        animation: statFade 0.5s ease forwards;
        opacity: 0;
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
    }

     .achievement-stats .stat i {
        font-size: 1.5rem;
        color: var(--primary);
        margin-bottom: var(--spacing-1);
     }

     /* Stagger animation */
    .achievement-stats .stat:nth-child(1) { animation-delay: 0.3s; }
    .achievement-stats .stat:nth-child(2) { animation-delay: 0.4s; }
    .achievement-stats .stat:nth-child(3) { animation-delay: 0.5s; }
    .achievement-stats .stat:nth-child(4) { animation-delay: 0.6s; }
    .achievement-stats .stat:nth-child(5) { animation-delay: 0.7s; }
    .achievement-stats .stat:nth-child(6) { animation-delay: 0.8s; }


    @keyframes statFade {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .next-challenge {
        margin-top: var(--spacing-6);
    }

    .next-challenge p {
         margin-bottom: var(--spacing-3);
         font-weight: 500;
    }

    /* Button Styles */
    .btn {
        padding: var(--spacing-3) var(--spacing-5);
        border: none;
        border-radius: var(--border-radius-full);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--font-size-base);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center; /* Center button content */
        gap: var(--spacing-2);
        text-decoration: none; /* Remove underline from button links */
        line-height: 1; /* Prevent extra height */
    }

     .btn i {
        font-size: 1.1em; /* Relative icon size */
     }

    .btn-primary {
        background: var(--gradient-sport);
        color: var(--white);
        box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sport);
    }

    .btn-yes {
         background-color: var(--success);
         color: var(--white);
         box-shadow: var(--shadow-sm);
     }
     .btn-yes:hover {
         background-color: #218838; /* Darker success */
         transform: translateY(-2px);
         box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
     }

     .btn-no {
         background-color: var(--text-secondary);
         color: var(--white);
         box-shadow: var(--shadow-sm);
     }
     .btn-no:hover {
         background-color: var(--text-primary);
         transform: translateY(-2px);
         box-shadow: 0 4px 10px rgba(108, 117, 125, 0.3);
     }

    .btn-reset {
        background: var(--white);
        border: 2px solid var(--danger);
        color: var(--danger);
        padding: var(--spacing-2) var(--spacing-4); /* Smaller reset button */
        font-size: var(--font-size-sm);
    }

    .btn-reset:hover {
        background: var(--danger);
        color: var(--white);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
    }

    .btn-container {
         text-align: center;
         margin-top: var(--spacing-6);
    }

    .btn-full {
        width: 100%;
    }

    /* User Welcome Styles */
    .user-welcome {
        display: none; /* Hidden until user logs in */
        align-items: center;
        padding: var(--spacing-2) var(--spacing-4);
        background: rgba(255, 255, 255, 0.2);
        color: var(--white);
        border-radius: var(--border-radius-full);
        font-weight: 500;
        animation: welcomeSlideIn 0.5s ease-out forwards;
        font-size: var(--font-size-sm);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes welcomeSlideIn {
        from { transform: translateX(30px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .user-avatar {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        font-size: 1.1rem;
    }

    .user-name-display {
        font-weight: 700;
        background: linear-gradient(120deg, #FF8F00, #FFEB3B, #FFC107);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        position: relative;
        padding: 0 4px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.1);
        font-size: 1.05em;
        letter-spacing: 0.5px;
        display: inline-block;
        animation: shimmer 3s infinite linear;
        background-size: 200% 100%;
    }

    @keyframes shimmer {
        0% { background-position: 0% 50%; }
        100% { background-position: 200% 50%; }
    }

    .user-name-display::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: -2px;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, #FFC107, transparent);
        border-radius: 2px;
        opacity: 0.8;
    }

    /* Onboarding Modal Styles */
    .onboarding-overlay {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.85) 0%, rgba(17, 24, 39, 0.95) 100%);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: var(--spacing-4);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
        min-height: 100vh;
    }

    .onboarding-modal {
        background: linear-gradient(to bottom right, var(--white) 0%, #f8fafc 100%);
        border-radius: var(--border-radius-xl);
        padding: var(--spacing-6) var(--spacing-5);
        width: 100%;
        max-width: 450px;
        max-height: 85vh;
        overflow-y: auto;
        text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 30px rgba(79, 70, 229, 0.1);
        position: relative;
        animation: modalScaleUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        margin: 2vh auto;
    }

    @keyframes modalScaleUp {
        from {
            transform: scale(0.9);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .onboarding-logo {
        margin-bottom: var(--spacing-5);
        position: relative;
        display: inline-block;
    }

    .onboarding-logo::before {
        content: '';
        position: absolute;
        width: 100px;
        height: 100px;
        background: linear-gradient(45deg, var(--primary-light), var(--primary));
        border-radius: 50%;
        filter: blur(25px);
        opacity: 0.4;
        z-index: -1;
        animation: pulsate 3s ease-in-out infinite;
    }

    @keyframes pulsate {
        0%, 100% { transform: scale(1); opacity: 0.4; }
        50% { transform: scale(1.2); opacity: 0.6; }
    }

    .onboarding-logo i {
        font-size: 3.5rem;
        background: var(--gradient-sport);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        display: inline-block;
        animation: logoRotate 3s ease-in-out infinite alternate;
        text-shadow: 0 5px 15px rgba(255, 75, 43, 0.2);
    }

    @keyframes logoRotate {
         0% { transform: rotate(-10deg) scale(1); }
         100% { transform: rotate(10deg) scale(1.1); }
    }

    .onboarding-modal h2 {
        color: var(--text-primary);
        font-size: var(--font-size-2xl);
        margin-bottom: var(--spacing-2);
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .onboarding-modal p {
        color: var(--text-secondary);
        font-size: var(--font-size-base);
        line-height: 1.6;
        margin-bottom: var(--spacing-6);
    }

    .form-group {
        margin-bottom: var(--spacing-5);
        text-align: left;
        position: relative;
        transition: all 0.3s ease;
    }

    .form-group:hover {
        transform: translateY(-2px);
    }

    .form-group label {
        display: block;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: var(--spacing-2);
        font-size: var(--font-size-sm);
        transition: color 0.3s ease;
    }

    .form-group:focus-within label {
        color: var(--primary);
    }

    .input-with-icon {
        position: relative;
    }

    .input-with-icon i {
        position: absolute;
        left: var(--spacing-4);
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 1.1rem;
        pointer-events: none;
        transition: color 0.3s ease;
    }

    .input-with-icon input:focus + i {
        color: var(--primary);
    }

    .input-with-icon input {
        width: 100%;
        padding: var(--spacing-4) var(--spacing-4) var(--spacing-4) calc(var(--spacing-4) * 2 + 1rem);
        border: 2px solid var(--input-border);
        border-radius: var(--border-radius-lg);
        font-size: var(--font-size-base);
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .input-with-icon input:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 0 0 4px rgba(255, 75, 43, 0.15);
    }

    .input-with-icon input::placeholder {
        color: #aaa;
    }

    /* Animated progress bar */
    .onboarding-progress {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: #edf2f7;
        overflow: hidden;
    }

    .onboarding-progress::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 30%;
        background: linear-gradient(to right, var(--primary), var(--secondary));
        animation: progressAnimation 2s ease-in-out infinite;
    }

    @keyframes progressAnimation {
        0% { left: -30%; }
        100% { left: 100%; }
    }

    /* Gender button animations */
    .gender-btn {
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
        position: relative;
        z-index: 1;
    }

    .gender-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--primary-light), var(--primary));
        opacity: 0;
        z-index: -1;
        transition: opacity 0.3s ease;
    }

    .gender-btn:hover::before {
        opacity: 0.1;
    }

    .gender-btn-active {
        transform: scale(1.05);
    }

    .gender-btn:not(.gender-btn-active):hover {
        border-color: var(--primary-light);
        transform: translateY(-3px);
    }

    /* Info buttons hover effect */
    .info-btn {
        transition: transform 0.3s ease, color 0.3s ease;
    }

    .info-btn:hover {
        transform: scale(1.2);
        color: var(--secondary) !important;
    }

    .info-text {
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Style for the BMI value based on category */
    .bmi-value-underweight {
        color: #3B82F6; /* Blue for underweight */
    }
    .bmi-value-normal {
        color: #10B981; /* Green for normal */
    }
    .bmi-value-overweight {
        color: #F59E0B; /* Amber for overweight */
    }
    .bmi-value-obese {
        color: #EF4444; /* Red for obese */
    }
    /* Add animation for BMI indicator */
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 75, 43, 0.4); }
        70% { transform: scale(1.2); box-shadow: 0 0 0 10px rgba(255, 75, 43, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 75, 43, 0); }
    }
    .bmi-indicator.pulse {
        animation: pulse 1s ease-in-out;
    }

    /* Body Fat Card Styles */
    .bodyfat-card {
        position: relative;
        overflow: visible;
    }
    
    .bodyfat-meter {
        margin-top: 10px;
        width: 100%;
    }
    
    .bodyfat-meter-bar {
        height: 10px;
        background: #f0f0f0;
        border-radius: 5px;
        position: relative;
        margin-bottom: 8px;
        overflow: hidden;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .bodyfat-progress-fill {
        height: 100%;
        background: linear-gradient(to right, 
            #2196F3 0%, /* Athletic - Blue */
            #4CAF50 25%, /* Fitness - Green */
            #FFC107 50%, /* Average - Yellow */
            #FF5722 75% /* Obese - Orange-Red */
        );
        border-radius: 5px;
        width: 0%; /* Will be set by JavaScript */
        transition: width 1s ease-in-out;
        position: absolute;
        left: 0;
        top: 0;
    }
    
    .bodyfat-indicator {
        width: 16px;
        height: 16px;
        background-color: white;
        border: 2px solid var(--primary);
        border-radius: 50%;
        position: absolute;
        top: -3px;
        transform: translateX(-50%);
        left: 0%; /* Will be set by JavaScript */
        transition: left 1s ease-in-out;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
        z-index: 10;
    }
    
    .bodyfat-scale {
        display: flex;
        justify-content: space-between;
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-top: 5px;
        padding: 0 5px;
    }
    
    /* Style for the Body Fat value based on category */
    .bodyfat-value-athletic {
        color: #2196F3; /* Blue */
    }
    
    .bodyfat-value-fitness {
        color: #4CAF50; /* Green */
    }
    
    .bodyfat-value-average {
        color: #FFC107; /* Yellow */
    }
    
    .bodyfat-value-obese {
        color: #FF5722; /* Orange-Red */
    }
    
    /* Add animation for Body Fat indicator */
    @keyframes pulse {
        0% { transform: translateX(-50%) scale(1); }
        50% { transform: translateX(-50%) scale(1.2); }
        100% { transform: translateX(-50%) scale(1); }
    }
    
    .bodyfat-indicator.pulse {
        animation: pulse 1s ease-in-out;
    }

    @media (max-height: 800px) {
        .onboarding-modal {
            padding: var(--spacing-4) var(--spacing-5);
        }
        
        .form-group {
            margin-bottom: var(--spacing-3);
        }
        
        .onboarding-logo {
            margin-bottom: var(--spacing-3);
        }
        
        .onboarding-logo i {
            font-size: 2.5rem;
        }
        
        .onboarding-modal h2 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--spacing-1);
        }
        
        .onboarding-modal p {
            margin-bottom: var(--spacing-4);
        }
    }
    
    /* Style the scrollbar for the modal */
    .onboarding-modal::-webkit-scrollbar {
        width: 8px;
    }
    
    .onboarding-modal::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    
    .onboarding-modal::-webkit-scrollbar-thumb {
        background: var(--primary-light);
        border-radius: 10px;
    }
    
    .onboarding-modal::-webkit-scrollbar-thumb:hover {
        background: var(--primary);
    }

    /* Footer Styles */
    .footer {
        background: linear-gradient(to right, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
        padding: var(--spacing-6) 0;
        margin-top: var(--spacing-8);
        box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05);
        border-top: 1px solid rgba(226, 232, 240, 0.8);
        position: relative;
        overflow: hidden;
    }

    .footer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(to right, var(--primary), var(--secondary), var(--tertiary));
    }

    .footer-logo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        font-size: var(--font-size-xl);
        font-weight: 700;
        color: var(--primary);
        margin-bottom: var(--spacing-4);
        transition: transform 0.3s ease;
    }

    .footer-logo:hover {
        transform: translateY(-3px);
    }

    .footer-logo i {
        font-size: 1.3em;
        background: var(--gradient-sport);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        filter: drop-shadow(0 2px 4px rgba(255, 75, 43, 0.2));
    }

    .copyright {
        text-align: center;
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
    }

    .copyright a {
        color: var(--primary);
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 500;
        position: relative;
        display: inline-block;
    }

    .copyright a::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 0;
        height: 2px;
        background: var(--gradient-sport);
        transition: width 0.3s ease;
    }

    .copyright a:hover {
        color: var(--secondary);
        transform: translateY(-1px);
    }

    .copyright a:hover::after {
        width: 100%;
    }

    .brand-name {
        font-weight: 600;
        background: var(--gradient-sport);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    /* Trophy Cabinet Styles */
    .trophy-cabinet-container {
        background: linear-gradient(to bottom right, var(--white), rgba(248, 250, 252, 0.8));
        border-radius: var(--border-radius-xl);
        padding: var(--spacing-6);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        margin-top: var(--spacing-8);
        border: 1px solid rgba(226, 232, 240, 0.8);
        position: relative;
        overflow: hidden;
    }

    .trophy-cabinet-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at top right, rgba(255, 215, 0, 0.1), transparent 70%);
        pointer-events: none;
    }

    .trophy-title {
        text-align: center;
        margin-bottom: var(--spacing-4);
        color: var(--text-primary);
        font-size: var(--font-size-2xl);
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-2);
        position: relative;
    }

    .trophy-title i {
        color: var(--tertiary);
        font-size: 1.3em;
        filter: drop-shadow(0 4px 6px rgba(255, 215, 0, 0.3));
        animation: trophyShine 3s ease-in-out infinite alternate;
    }

    @keyframes trophyShine {
        0% { text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
        100% { text-shadow: 0 0 15px rgba(255, 215, 0, 0.7); }
    }

    .trophy-description {
        text-align: center;
        color: var(--text-secondary);
        font-size: var(--font-size-base);
        line-height: 1.7;
        margin-bottom: var(--spacing-6);
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
    }

    .trophies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: var(--spacing-5);
        justify-content: center;
        min-height: 100px;
        align-items: center;
    }

    .trophy-item {
        text-align: center;
        animation: trophyPopIn 0.5s ease-out backwards;
        position: relative;
        padding: var(--spacing-3);
        border-radius: var(--border-radius-lg);
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(226, 232, 240, 0.6);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transform-style: preserve-3d;
        perspective: 1000px;
    }

    .trophy-item:hover {
        transform: translateY(-5px) rotateX(5deg);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.08);
        z-index: 1;
        border-color: rgba(255, 215, 0, 0.3);
    }

    /* Stagger trophy animation */
    .trophy-item:nth-child(1) { animation-delay: 0.1s; }
    .trophy-item:nth-child(2) { animation-delay: 0.2s; }
    .trophy-item:nth-child(3) { animation-delay: 0.3s; }
    .trophy-item:nth-child(4) { animation-delay: 0.4s; }
    .trophy-item:nth-child(5) { animation-delay: 0.5s; }
    /* Add more if needed */

    @keyframes trophyPopIn {
        from { transform: scale(0.5) rotate(-15deg); opacity: 0; }
        to { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .trophy-icon {
        position: relative;
        margin-bottom: var(--spacing-3);
    }

    .trophy-icon i {
        font-size: 3rem;
        color: var(--tertiary);
        display: inline-block;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 4px 8px rgba(255, 215, 0, 0.3));
    }

    .trophy-item:hover .trophy-icon i {
        transform: translateY(-5px) rotate(15deg);
        filter: drop-shadow(0 8px 15px rgba(255, 215, 0, 0.5));
    }

    .trophy-item:hover::after {
        opacity: 1;
        transform: translateY(0);
    }

    .trophy-label {
        font-size: var(--font-size-base);
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: var(--spacing-1);
        transition: color 0.3s ease;
    }

    .trophy-item:hover .trophy-label {
        background: var(--gradient-achievement);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .trophy-year {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 2px;
        opacity: 0.8;
        transition: all 0.3s ease;
    }

    .trophy-item:hover .trophy-year {
        opacity: 1;
        color: var(--primary);
    }

    .no-trophies-message {
        text-align: center;
        color: var(--text-secondary);
        padding: var(--spacing-8) 0;
        font-style: italic;
        font-size: var(--font-size-base);
        line-height: 1.6;
        background: rgba(248, 250, 252, 0.8);
        border-radius: var(--border-radius-lg);
        border: 1px dashed rgba(226, 232, 240, 0.8);
        animation: fadeIn 1s ease-out;
    }

    /* Responsive adjustments for trophy cabinet */
    @media (max-width: 768px) {
        .trophy-cabinet-container {
            padding: var(--spacing-4);
        }
        
        .trophies-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: var(--spacing-3);
        }
        
        .trophy-icon i {
            font-size: 2.5rem;
        }
        
        .trophy-label {
            font-size: 0.9rem;
        }
    }

    @media (max-width: 480px) {
        .trophies-grid {
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: var(--spacing-2);
        }
        
        .trophy-icon i {
            font-size: 2rem;
        }
        
        .trophy-label {
            font-size: 0.8rem;
        }
        
        .trophy-year {
            font-size: 0.7rem;
        }
    }

    /* إخفاء جميع عناصر BMI */
    .bmi-card, .bmi-meter, .bmi-indicator, .bmi-meter-bar, .bmi-scale, .bmi-progress-fill, [id="bmi-value"], [id="bmi-category"] {
        display: none !important;
    }

    /* Modal Animation Enhancements */
    .modal-overlay {
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal {
        transform: translateY(30px) scale(0.95);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active .modal {
        transform: translateY(0) scale(1);
        opacity: 1;
    }

    /* Calendar Day Hover Effects */
    .calendar-date {
        transition: all 0.2s ease;
    }

    .calendar-date:not(.disabled):hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .calendar-date.completed:hover {
        background: var(--success);
    }

    .calendar-date.gym-day:hover {
        background: var(--info);
    }

    /* Button Hover Effects */
    .btn {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .btn:after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.3);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%, -50%);
        transform-origin: 50% 50%;
    }

    .btn:hover:after {
        animation: ripple 0.6s ease-out;
    }

    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 1;
        }
        20% {
            transform: scale(25, 25);
            opacity: 1;
        }
        100% {
            opacity: 0;
            transform: scale(40, 40);
        }
    }

    /* Activity Button Enhancements */
    .activity-buttons .btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .activity-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }

    .activity-buttons .btn-primary {
        background: var(--primary);
    }

    .activity-buttons .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    }

    .activity-buttons .btn-secondary {
        background: #f8f9fa;
        color: var(--text-primary);
        border: 1px solid #dee2e6;
    }

    .activity-buttons .btn-secondary:hover {
        background: #e9ecef;
    }

    .btn-reset:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 25px rgba(0,0,0,0.25), 0 5px 10px rgba(0,0,0,0.15), inset 0 -2px 5px rgba(0,0,0,0.3);
        background: linear-gradient(145deg, #364154, #1e293b);
    }
    
    .btn-reset:active {
        transform: translateY(1px);
        box-shadow: 0 5px 10px rgba(0,0,0,0.2), 0 2px 5px rgba(0,0,0,0.1), inset 0 -1px 3px rgba(0,0,0,0.3);
    }
    
    .btn-reset:hover .reset-icon {
        animation: spin 4s infinite linear;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .btn-reset:hover .reset-pulse {
        animation: pulse 1.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    
    @keyframes pulse {
        0% { transform: scale(0); opacity: 0.8; }
        100% { transform: scale(1); opacity: 0; }
    }
</style>
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="container header-content">
        <a href="#" class="logo">
                <i class="fas fa-dumbbell"></i>
            <span>FitChallenge</span>
        </a>
        <div class="user-actions" style="display: flex; align-items: center; gap: 15px; margin-left: auto;">
            <div class="user-welcome" id="user-welcome">
                <span>Welcome, <span class="user-name-display" id="header-user-name">User</span></span>
            </div>
            <button class="header-action-btn" id="reset-btn" title="Reset App Data">
                <i class="fas fa-sync-alt"></i>
                <span>Reset</span>
            </button>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="main">
    <div class="container">
        <!-- Challenge App Container -->
        <div id="challenge-app-container" style="display: none;"> 
            <h1 class="app-title" style="text-align: center; margin: 25px auto 35px; color: #333; font-size: 2.2rem; font-weight: 700; padding: 15px 0; position: relative; max-width: 500px;">
                <span style="position: relative; display: inline-block;">
                    Your 30-Day Challenge
                    <span style="position: absolute; bottom: -8px; left: 10%; right: 10%; height: 3px; background: linear-gradient(to right, transparent, var(--primary), transparent); border-radius: 2px;"></span>
                </span>
            </h1>
            
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-label">
                    <span id="progress-text">Progress</span>
                    <span id="progress-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                </div>
            </div>
            
            <!-- Stats Container -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i> <!-- Changed icon -->
                    </div>
                    <div class="stat-title" id="completed-title">Active Days</div> <!-- Changed title -->
                    <div class="stat-value completed-value" id="active-days">0</div> <!-- Changed ID -->
                    <div class="stat-description" id="completed-desc">Out of 30 days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="stat-title" id="remaining-title">Days Left</div>
                    <div class="stat-value days-left-value" id="days-left">30</div>
                    <div class="stat-description" id="remaining-desc">To reach goal</div> <!-- Changed description -->
                </div>
                <!-- BMI Card - New -->
                <div class="stat-card bmi-card">
                    <div class="stat-icon">
                        <i class="fas fa-weight"></i>
                    </div>
                    <div class="stat-title">BMI</div>
                    <div class="stat-value" id="bmi-value">0</div>
                    <div class="stat-description" id="bmi-category">--</div>
                    <div class="bmi-meter">
                        <div class="bmi-meter-bar">
                            <div class="bmi-progress-fill" id="bmi-progress-fill"></div>
                            <div class="bmi-indicator" id="bmi-indicator"></div>
                        </div>
                        <div class="bmi-scale">
                            <span>Underweight</span>
                            <span>Normal</span>
                            <span>Overweight</span>
                            <span>Obese</span>
                        </div>
                    </div>
                </div>
                <!-- Body Fat Card - New -->
                <div class="stat-card bodyfat-card">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-title">Body Fat</div>
                    <div class="stat-value" id="bodyfat-value">0%</div>
                    <div class="stat-description" id="bodyfat-category">--</div>
                    <div class="bodyfat-meter">
                        <div class="bodyfat-meter-bar">
                            <div class="bodyfat-progress-fill" id="bodyfat-progress-fill"></div>
                            <div class="bodyfat-indicator" id="bodyfat-indicator"></div>
                        </div>
                        <div class="bodyfat-scale">
                            <span>Athletic</span>
                            <span>Fitness</span>
                            <span>Average</span>
                            <span>Obese</span>
                        </div>
                    </div>
                </div>
                <!-- Gym Days Stat Card (Hidden) -->
                <div class="stat-card" style="display: none;">
                    <div class="stat-icon">
                        <i class="fas fa-dumbbell"></i>
                    </div>
                    <div class="stat-title">Gym Days</div>
                    <div class="stat-value" id="gym-days">0</div>
                    <div class="stat-description">Visits recorded</div>
                </div>
            </div>
            
            <!-- Calendar Structure -->
            <div class="calendar">
                <div class="calendar-header">
                    <button class="month-nav prev-month" id="prev-month" title="Previous Month">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="current-month" id="current-month">Month Year</div>
                    <button class="month-nav next-month" id="next-month" title="Next Month">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="calendar-days" id="weekday-labels">
                    <div class="weekday">Sun</div>
                    <div class="weekday">Mon</div>
                    <div class="weekday">Tue</div>
                    <div class="weekday">Wed</div>
                    <div class="weekday">Thu</div>
                    <div class="weekday">Fri</div>
                    <div class="weekday">Sat</div>
                </div>
                <div class="calendar-dates" id="calendar-dates">
                    <!-- Dates will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Trophy Cabinet -->
            <div class="trophy-cabinet-container" id="trophy-cabinet">
                <h3 class="trophy-title">
                    <i class="fas fa-medal"></i> Your Achievements
                </h3>
                <p class="trophy-description" id="trophy-desc">
                    Each trophy represents a successfully completed 30-day fitness challenge. Keep up the great work!
                </p>
                <div class="trophies-grid" id="trophies-grid">
                    <!-- Trophies will be added here dynamically -->
                </div>
            </div>
        </div>
        <!-- End #challenge-app-container -->
        
        <!-- Message shown when not logged in -->
        <div id="login-prompt" style="text-align: center; margin-top: var(--spacing-8); display: none;">
            Please log in to start your challenge.
        </div>

    </div>
</main>

<!-- Day Modal Structure -->
<div class="modal-overlay" id="day-modal">
    <div class="modal" role="dialog" aria-labelledby="day-modal-title">
        <div class="modal-header">
            <div class="modal-title-container">
                <h3 class="modal-title" id="day-modal-title">Day 1</h3>
                <div class="modal-subtitle" id="day-modal-subtitle">First Steps</div>
            </div>
            <button class="modal-close" id="day-modal-close" title="Close Modal">×</button>
        </div>
        
        <!-- Activity Selection Section -->
        <div class="modal-section" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
            <p style="font-size: var(--font-size-sm); color: var(--text-secondary); text-align: center; margin-bottom: 15px;">
                Choose your activity for this day:
            </p>
            <div class="activity-buttons" style="display: flex; justify-content: center; gap: 10px;">
                <button class="btn btn-primary" id="btn-home-workout" style="flex: 1;" title="Choose Home Workout">
                    <i class="fas fa-home"></i> Home Workout
                </button>
                <button class="btn btn-secondary" id="btn-gym" style="flex: 1;" title="Choose Gym Workout">
                    <i class="fas fa-dumbbell"></i> Gym Day
                </button>
            </div>
        </div>
        
        <!-- Workout Details Section -->
        <div class="modal-content">
            <div class="workout-info" id="workout-info-container" style="display: none;">
                <div class="workout-title" id="workout-title">
                    <i class="fas fa-dumbbell"></i> Today's Workout
                </div>
                <div id="workout-list" class="workout-list">
                    <!-- Will be filled by JS -->
                </div>
            </div>
        </div>
        
        <!-- Action Buttons Section -->
        <div class="modal-actions" id="workout-question" style="justify-content: space-between;">
            <button class="btn btn-no" id="btn-no" title="No, Skip Workout">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-yes" id="btn-mark-complete" style="display: none;" title="Yes, Mark as Complete">
                <i class="fas fa-check-circle"></i> Mark Complete
            </button>
        </div>
        
        <!-- Completion Message Section -->
        <div class="modal-actions" id="completed-message" style="display: none;">
            <p style="flex-grow: 1; text-align: center; color: var(--success); font-weight: 500;" id="completion-status-text">
                Challenge Workout Completed!
            </p>
            <div style="display: flex; gap: 10px; justify-content: center; width: 100%;">
                <button class="btn btn-warning" id="btn-reset-day" title="Reset Day">
                    <i class="fas fa-undo"></i> Cancel Workout
                </button>
                <button class="btn btn-primary" id="btn-close" title="Close Modal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Onboarding Modal -->
<div class="modal-overlay onboarding-overlay" id="onboarding-overlay">
     <div class="modal onboarding-modal" role="dialog" aria-labelledby="onboarding-title" aria-modal="true">
        <div class="onboarding-progress"></div>
        <div class="onboarding-logo">
            <i class="fas fa-dumbbell"></i>
        </div>
        <h2 id="onboarding-title">Let's Get Started!</h2>
        <p id="onboarding-message">Join the challenge and transform your fitness journey</p>
        
        <form id="onboarding-form">
            <div class="form-group">
                <label for="user-name">Your Name</label>
                <div class="input-with-icon">
                    <input type="text" id="user-name" name="user-name" placeholder="Enter your name" required>
                    <i class="fas fa-user"></i>
                </div>
            </div>
            
            <!-- Gender Selection -->
            <div class="form-group">
                <label>Gender</label>
                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <button type="button" id="male-gender-btn" class="gender-btn gender-btn-active" title="Select Male"
                            style="flex: 1; padding: 12px; border: 2px solid var(--primary); background: var(--primary); color: white; border-radius: var(--border-radius-lg); cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(255, 75, 43, 0.2);">
                        <i class="fas fa-male"></i> Male
                    </button>
                    <button type="button" id="female-gender-btn" class="gender-btn" title="Select Female"
                            style="flex: 1; padding: 12px; border: 2px solid #e2e8f0; background: #f8f9fa; color: var(--text-primary); border-radius: var(--border-radius-lg); cursor: pointer; transition: all 0.3s ease;">
                        <i class="fas fa-female"></i> Female
                    </button>
                </div>
            </div>
            
            <!-- Height Input -->
            <div class="form-group">
                <label for="user-height">Height (cm) <span style="font-size: 0.8em; color: var(--text-secondary);">(optional)</span></label>
                <div class="input-with-icon">
                    <input type="number" id="user-height" name="user-height" min="100" max="250" placeholder="Your height (optional)">
                    <i class="fas fa-ruler-vertical"></i>
                </div>
            </div>
            
            <!-- Neck Input -->
            <div class="form-group">
                <label for="user-neck">Neck Circumference (cm) <span style="font-size: 0.8em; color: var(--text-secondary);">(optional)</span></label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="input-with-icon" style="flex-grow: 1;">
                        <input type="number" id="user-neck" name="user-neck" min="20" max="80" placeholder="Neck measurement (optional)">
                        <i class="fas fa-circle-notch"></i>
                    </div>
                    <button type="button" class="info-btn" id="neck-info-btn" 
                            style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 18px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease;"
                            title="Neck Measurement Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
                <div id="neck-info" class="info-text" 
                     style="display: none; font-size: 0.8rem; color: var(--text-secondary); background: rgba(248, 250, 252, 0.8); padding: 10px; border-radius: var(--border-radius); margin-top: 8px; border-left: 3px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    Measure your neck circumference below the Adam's apple. Keep the measuring tape level and snug but not tight.
                </div>
            </div>
            
            <!-- Waist Input -->
            <div class="form-group">
                <label for="user-waist">Waist Circumference (cm) <span style="font-size: 0.8em; color: var(--text-secondary);">(optional)</span></label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="input-with-icon" style="flex-grow: 1;">
                        <input type="number" id="user-waist" name="user-waist" min="50" max="200" placeholder="Waist measurement (optional)">
                        <i class="fas fa-expand"></i>
                    </div>
                    <button type="button" class="info-btn" id="waist-info-btn" 
                            style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 18px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease;"
                            title="Waist Measurement Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
                <div id="waist-info" class="info-text" 
                     style="display: none; font-size: 0.8rem; color: var(--text-secondary); background: rgba(248, 250, 252, 0.8); padding: 10px; border-radius: var(--border-radius); margin-top: 8px; border-left: 3px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    For men: Measure at the level of the navel (belly button). For women: Measure at the narrowest point, usually above the navel and below the ribcage.
                </div>
            </div>
            
            <!-- Hip Input (For females) -->
            <div class="form-group" id="hip-input-group" style="display: none;">
                <label for="user-hip">Hip Circumference (cm) <span style="font-size: 0.8em; color: var(--text-secondary);">(optional)</span></label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="input-with-icon" style="flex-grow: 1;">
                        <input type="number" id="user-hip" name="user-hip" min="50" max="200" placeholder="Hip measurement (optional)">
                        <i class="fas fa-ruler-horizontal"></i>
                    </div>
                    <button type="button" class="info-btn" id="hip-info-btn" 
                            style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 18px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease;"
                            title="Hip Measurement Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
                <div id="hip-info" class="info-text" 
                     style="display: none; font-size: 0.8rem; color: var(--text-secondary); background: rgba(248, 250, 252, 0.8); padding: 10px; border-radius: var(--border-radius); margin-top: 8px; border-left: 3px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    Measure at the widest part of your buttocks. Keep the measuring tape level and wrapped comfortably around.
                </div>
            </div>
            
            <!-- Tips Section -->
            <div style="margin: 15px 0; padding: 12px; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-radius: var(--border-radius-lg); color: #92400e; border-left: 4px solid #f59e0b; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <h4 style="margin-bottom: 6px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-lightbulb" style="color: #f59e0b;"></i> Information
                </h4>
                <p style="font-size: 0.8rem; margin-bottom: 6px;">
                    Only name is required. Body fat will be calculated using the US Army formula if measurements are provided.
                </p>
                <ul style="font-size: 0.8rem; padding-left: 20px; margin: 0;">
                    <li>For accurate body fat measurement, provide all required fields</li>
                    <li>For men: height, neck, and waist measurements</li> 
                    <li>For women: height, neck, waist, and hip measurements</li>
                    <li>All measurements should be in centimeters</li>
                </ul>
            </div>
            
            <button type="submit" class="btn btn-primary" id="start-btn" title="Start Challenge"
                    style="width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 600; margin-top: 10px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border: none; box-shadow: 0 4px 15px rgba(255, 75, 43, 0.3); transition: all 0.3s ease; transform: translateY(0); display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-play-circle"></i> Start Your Challenge
            </button>
        </form>
        
        <div style="margin-top: 20px; font-size: 0.85rem; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; gap: 5px;">
            <i class="fas fa-shield-alt"></i> Your data is stored locally and never shared
        </div>
    </div>
</div>

<!-- Achievement Modal -->
<div class="modal-overlay" id="achievement-modal">
    <div class="modal achievement-modal" role="dialog">
        <i class="fas fa-trophy achievement-icon"></i>
        <h2 class="achievement-title">Challenge Complete!</h2>
        <p class="achievement-message">Congratulations! You've completed the 30-day challenge!</p>
        <div class="achievement-stats">
            <p>This is your <strong id="completion-number">1st</strong> challenge completion!</p>
        </div>
        <button class="btn btn-primary" id="start-new-challenge" title="Start New Challenge">
            <i class="fas fa-plus-circle"></i> Start New Challenge
        </button>
    </div>
</div>

<!-- Add Reset Options Modal -->
<div class="modal-overlay" id="reset-modal">
    <div class="modal" role="dialog">
        <div class="modal-header">
            <h3 class="modal-title">Reset Options</h3>
            <button class="month-nav modal-close" id="reset-modal-close" title="Close Modal">
                ×
            </button>
        </div>
        <div class="modal-content" style="text-align: center;">
            <p style="margin-bottom: var(--spacing-4); color: var(--text-secondary);">
                Choose what you want to reset:
            </p>
            <div style="display: flex; flex-direction: column; gap: var(--spacing-3);">
                <button class="btn btn-warning" id="reset-month" title="Reset Current Month">
                    <i class="fas fa-sync"></i> Reset This Month
                </button>
                <button class="btn btn-danger" id="reset-all" title="Reset All Data">
                    <i class="fas fa-trash-alt"></i> Reset All Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="footer-logo">
            <i class="fas fa-dumbbell"></i>
            <span>FitChallenge</span>
        </div>
        <div class="copyright">
            <p>
                <span class="brand-name">FitChallenge</span> © - Developed by
                <a href="https://moibrahim0115.github.io/cv/?" target="_blank" rel="noopener noreferrer">Mohamed Ibrahim</a>
                <span id="year">2025</span>
            </p>
        </div>
    </div>
</footer>


<!-- Updated JavaScript -->
<script>
    // Basic Setup & Constants
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const weekdayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    
    // Challenge Data (Generate dynamically)
    const challengeData = [
        {
            day: 1,
            title: "First Steps",
            exercises: [
                { name: "Push-ups", reps: "10 reps" },
                { name: "Squats", reps: "15 reps" },
                { name: "Plank", reps: "30 seconds" }
            ]
        },
        {
            day: 2,
            title: "Building Momentum",
            exercises: [
                { name: "Mountain Climbers", reps: "20 reps" },
                { name: "Lunges", reps: "10 each leg" },
                { name: "Bicycle Crunches", reps: "20 reps" }
            ]
        },
        {
            day: 3,
            title: "Core Power",
            exercises: [
                { name: "Sit-ups", reps: "15 reps" },
                { name: "Russian Twists", reps: "20 reps" },
                { name: "Leg Raises", reps: "12 reps" }
            ]
        },
        {
            day: 4,
            title: "Endurance Builder",
            exercises: [
                { name: "Jumping Jacks", reps: "30 reps" },
                { name: "High Knees", reps: "30 seconds" },
                { name: "Burpees", reps: "10 reps" }
            ]
        },
        {
            day: 5,
            title: "Upper Body Focus",
            exercises: [
                { name: "Diamond Push-ups", reps: "8 reps" },
                { name: "Tricep Dips", reps: "12 reps" },
                { name: "Arm Circles", reps: "20 each direction" }
            ]
        },
        {
            day: 6,
            title: "Lower Body Power",
            exercises: [
                { name: "Jump Squats", reps: "15 reps" },
                { name: "Calf Raises", reps: "20 reps" },
                { name: "Wall Sit", reps: "45 seconds" }
            ]
        },
        {
            day: 7,
            title: "Active Recovery",
            exercises: [
                { name: "Stretching Routine", reps: "10 mins" },
                { name: "Light Walking", reps: "15 mins" },
                { name: "Deep Breathing", reps: "5 mins" }
            ]
        },
        {
            day: 8,
            title: "Week 2: Building Strength",
            exercises: [
                { name: "Push-ups", reps: "12 reps" },
                { name: "Squats", reps: "20 reps" },
                { name: "Plank", reps: "45 seconds" }
            ]
        },
        {
            day: 9,
            title: "Coordination Day",
            exercises: [
                { name: "Mountain Climbers", reps: "25 reps" },
                { name: "Alternating Lunges", reps: "12 each leg" },
                { name: "Side Planks", reps: "30 seconds each side" }
            ]
        },
        {
            day: 10,
            title: "Core Challenge",
            exercises: [
                { name: "Sit-ups", reps: "20 reps" },
                { name: "Russian Twists", reps: "25 reps" },
                { name: "Leg Raises", reps: "15 reps" }
            ]
        },
        {
            day: 11,
            title: "Cardio Day",
            exercises: [
                { name: "Jumping Jacks", reps: "40 reps" },
                { name: "High Knees", reps: "40 seconds" },
                { name: "Burpees", reps: "12 reps" }
            ]
        },
        {
            day: 12,
            title: "Arms & Shoulders",
            exercises: [
                { name: "Regular Push-ups", reps: "15 reps" },
                { name: "Tricep Dips", reps: "15 reps" },
                { name: "Arm Raises", reps: "12 reps each direction" }
            ]
        },
        {
            day: 13,
            title: "Legs & Glutes",
            exercises: [
                { name: "Lunges", reps: "15 each leg" },
                { name: "Sumo Squats", reps: "15 reps" },
                { name: "Glute Bridges", reps: "20 reps" }
            ]
        },
        {
            day: 14,
            title: "Active Recovery",
            exercises: [
                { name: "Stretching Routine", reps: "15 mins" },
                { name: "Yoga Basics", reps: "10 mins" },
                { name: "Deep Breathing", reps: "5 mins" }
            ]
        },
        {
            day: 15,
            title: "Week 3: Leveling Up",
            exercises: [
                { name: "Push-ups", reps: "15 reps" },
                { name: "Jump Squats", reps: "12 reps" },
                { name: "Plank", reps: "60 seconds" }
            ]
        },
        {
            day: 16,
            title: "Dynamic Movement",
            exercises: [
                { name: "Burpees", reps: "10 reps" },
                { name: "Mountain Climbers", reps: "30 reps" },
                { name: "Jumping Lunges", reps: "10 each leg" }
            ]
        },
        {
            day: 17,
            title: "Core Strength",
            exercises: [
                { name: "V-Ups", reps: "15 reps" },
                { name: "Russian Twists", reps: "30 reps" },
                { name: "Flutter Kicks", reps: "20 seconds" }
            ]
        },
        {
            day: 18,
            title: "HIIT Training",
            exercises: [
                { name: "High Knees", reps: "45 seconds" },
                { name: "Jumping Jacks", reps: "45 seconds" },
                { name: "Squat Jumps", reps: "15 reps" }
            ]
        },
        {
            day: 19,
            title: "Upper Body Power",
            exercises: [
                { name: "Push-ups (Wide Grip)", reps: "12 reps" },
                { name: "Push-ups (Close Grip)", reps: "12 reps" },
                { name: "Superman Holds", reps: "3 x 15 seconds" }
            ]
        },
        {
            day: 20,
            title: "Lower Body Focus",
            exercises: [
                { name: "Squats", reps: "25 reps" },
                { name: "Lunges", reps: "15 each leg" },
                { name: "Calf Raises", reps: "25 reps" }
            ]
        },
        {
            day: 21,
            title: "Active Recovery",
            exercises: [
                { name: "Full Body Stretch", reps: "15 mins" },
                { name: "Light Walking", reps: "20 mins" },
                { name: "Meditation", reps: "5 mins" }
            ]
        },
        {
            day: 22,
            title: "Week 4: Peak Performance",
            exercises: [
                { name: "Push-ups", reps: "20 reps" },
                { name: "Squats", reps: "30 reps" },
                { name: "Plank", reps: "75 seconds" }
            ]
        },
        {
            day: 23,
            title: "Endurance Challenge",
            exercises: [
                { name: "Mountain Climbers", reps: "40 reps" },
                { name: "Jumping Jacks", reps: "50 reps" },
                { name: "High Knees", reps: "50 seconds" }
            ]
        },
        {
            day: 24,
            title: "Core Mastery",
            exercises: [
                { name: "Sit-ups", reps: "25 reps" },
                { name: "Russian Twists", reps: "40 reps" },
                { name: "Leg Raises", reps: "20 reps" }
            ]
        },
        {
            day: 25,
            title: "Full Body Workout",
            exercises: [
                { name: "Burpees", reps: "15 reps" },
                { name: "Push-ups", reps: "15 reps" },
                { name: "Squats", reps: "25 reps" }
            ]
        },
        {
            day: 26,
            title: "Upper Body Finale",
            exercises: [
                { name: "Push-ups", reps: "3 sets of 10 reps" },
                { name: "Tricep Dips", reps: "3 sets of 10 reps" },
                { name: "Pike Push-ups", reps: "10 reps" }
            ]
        },
        {
            day: 27,
            title: "Lower Body Finale",
            exercises: [
                { name: "Squats", reps: "3 sets of 15 reps" },
                { name: "Lunges", reps: "3 sets of 10 each leg" },
                { name: "Wall Sit", reps: "60 seconds" }
            ]
        },
        {
            day: 28,
            title: "Active Recovery",
            exercises: [
                { name: "Full Stretching Routine", reps: "20 mins" },
                { name: "Light Walking", reps: "20 mins" },
                { name: "Deep Breathing", reps: "10 mins" }
            ]
        },
        {
            day: 29,
            title: "Challenge Finale - Day 1",
            exercises: [
                { name: "Push-ups", reps: "25 reps" },
                { name: "Squats", reps: "35 reps" },
                { name: "Plank", reps: "90 seconds" }
            ]
        },
        {
            day: 30,
            title: "Challenge Finale - Final Day!",
            exercises: [
                { name: "Full Body Circuit", reps: "3 rounds" },
                { name: "Favorite Exercises", reps: "Your choice" },
                { name: "Celebration Stretch", reps: "10 mins" }
            ]
        }
    ];

// DOM Elements
    const yearElement = document.getElementById('year');
const onboardingOverlay = document.getElementById('onboarding-overlay');
const onboardingForm = document.getElementById('onboarding-form');
const userNameInput = document.getElementById('user-name');
const userWelcome = document.getElementById('user-welcome');
    const headerUserName = document.getElementById('header-user-name');
    const showOnboardingDebugBtn = document.getElementById('show-onboarding-debug'); 
    const challengeAppContainer = document.getElementById('challenge-app-container');
    const loginPrompt = document.getElementById('login-prompt');
    // Calendar DOM Elements
    const currentMonthElement = document.getElementById('current-month');
    const calendarDates = document.getElementById('calendar-dates');
const prevMonthBtn = document.getElementById('prev-month');
const nextMonthBtn = document.getElementById('next-month');
    // Day Modal DOM Elements
    const dayModalOverlay = document.getElementById('day-modal');
    const dayModalTitle = document.getElementById('day-modal-title');
    const dayModalSubtitle = document.getElementById('day-modal-subtitle');
    const dayModalCloseBtn = document.getElementById('day-modal-close');
    const workoutListContainer = document.getElementById('workout-list');
    const workoutInfoContainer = document.getElementById('workout-info-container');
    const workoutQuestionActions = document.getElementById('workout-question');
    const completedMessageActions = document.getElementById('completed-message');
    const btnModalCancel = document.getElementById('btn-no');
    const btnHomeWorkout = document.getElementById('btn-home-workout');
    const btnGym = document.getElementById('btn-gym');
    const btnMarkComplete = document.getElementById('btn-mark-complete');
    const completionStatusText = document.getElementById('completion-status-text');
    const btnModalCloseConfirm = document.getElementById('btn-close');
    const btnResetDay = document.getElementById('btn-reset-day');
    // Stats and Progress DOM Elements
    const progressFill = document.getElementById('progress-fill');
    const progressPercentage = document.getElementById('progress-percentage');
    const activeDaysElement = document.getElementById('active-days');
    const daysLeftElement = document.getElementById('days-left');
    const gymDaysElement = document.getElementById('gym-days');
    const resetBtn = document.getElementById('reset-btn');
    
    // App State
    let userName = null;
    let currentDisplayMonth = new Date().getMonth();
    let currentDisplayYear = new Date().getFullYear();
    let startDate = null; // Will be set on first onboarding or loaded
    let completedDays = []; // Stores YYYY-MM-DD strings
    let gymDays = []; // Stores YYYY-MM-DD strings
    let selectedDateString = null; // Track which date modal is open for
    let selectedWorkoutType = null;
    let completedExercises = new Set();
    let challengeCompletions = 0; // Total number of completions
    let trophies = []; // Array to store trophy information (month/year)
    // Body Fat State
    let userGender = 'male'; // Default gender
    let userHeight = 0;
    let userNeck = 0;
    let userWaist = 0;
    let userHip = 0; // Only used for female
    let userBodyFat = 0;
    
    function showOnboarding() {
        if (userNameInput) userNameInput.style.border = '1px solid #ccc'; 
        if (onboardingOverlay) {
            onboardingOverlay.classList.add('active');
            setTimeout(() => userNameInput?.focus(), 300);
        }
    }
    
    function hideOnboarding() {
        if (onboardingOverlay) {
            onboardingOverlay.classList.remove('active');
        }
    }
    
    // --- Initialization ---
function init() {
        console.log('Initializing App...');
        if (yearElement) {
            yearElement.textContent = new Date().getFullYear();
        }
        loadUserData();
        setupEventListeners();
        setupBodyFatFormInteractions(); // Setup Body Fat form interactions
        
        // Make sure gym days stat card stays hidden
        const gymStatCard = document.querySelector('.stat-card:nth-child(4)'); // Changed to 4th because we added Body Fat card
        if (gymStatCard) {
            gymStatCard.style.display = 'none';
        }
        
        if (userName) {
            showUserWelcome();
            hideOnboarding();
            initializeChallengeView(); 
            updateBodyFatDisplay(); // Update Body Fat display
            updateStats(); // Initial stat calculation
            console.log(`User ${userName} loaded.`);
            
            // تحديث مؤشر تقدم التحدي
            const totalActiveDays = [...new Set([...completedDays, ...gymDays])].length;
            const progress = totalActiveDays >= 30 ? 100 : (totalActiveDays / 30) * 100;
            if (progressFill) progressFill.style.width = `${progress}%`;
            if (progressPercentage) progressPercentage.textContent = `${Math.round(progress)}%`;
            
        } else {
            showOnboarding();
            if(loginPrompt) loginPrompt.style.display = 'block';
            console.log('No user found, showing onboarding.');
        }
        console.log('App Initialized.');
    }
    
    // --- Event Listeners ---
function setupEventListeners() {
         console.log('Setting up listeners...');
        if (onboardingForm) {
onboardingForm.addEventListener('submit', handleOnboardingSubmit);
        }
         if (showOnboardingDebugBtn) {
             showOnboardingDebugBtn.style.display = 'inline-block'; 
             showOnboardingDebugBtn.addEventListener('click', showOnboarding);
         }
        // Calendar Navigation
        if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
        if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => navigateMonth(1));
        // Day Modal Actions
        if (dayModalCloseBtn) dayModalCloseBtn.addEventListener('click', closeDayModal);
        if (btnModalCancel) btnModalCancel.addEventListener('click', closeDayModal);
        if (btnModalCloseConfirm) btnModalCloseConfirm.addEventListener('click', closeDayModal);
        if (btnHomeWorkout) btnHomeWorkout.addEventListener('click', handleHomeWorkout);
        if (btnGym) btnGym.addEventListener('click', handleGymVisitMark);
        if (btnMarkComplete) btnMarkComplete.addEventListener('click', handleWorkoutComplete);
        if (btnResetDay) btnResetDay.addEventListener('click', handleResetDay);
        // Close modal on overlay click
        if (dayModalOverlay) {
            dayModalOverlay.addEventListener('click', (e) => {
                if (e.target === dayModalOverlay) closeDayModal();
            });
        }
         // Close modal with ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && dayModalOverlay && dayModalOverlay.classList.contains('active')) {
                closeDayModal();
            }
        });
        // Reset Button and Modal
        const resetModalOverlay = document.getElementById('reset-modal');
        const resetModalClose = document.getElementById('reset-modal-close');
        const resetMonthBtn = document.getElementById('reset-month');
        const resetAllBtn = document.getElementById('reset-all');

        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                if (resetModalOverlay) resetModalOverlay.classList.add('active');
            });
        }

        if (resetModalClose) {
            resetModalClose.addEventListener('click', () => {
                if (resetModalOverlay) resetModalOverlay.classList.remove('active');
            });
        }

        if (resetMonthBtn) {
            resetMonthBtn.addEventListener('click', handleResetMonth);
        }

        if (resetAllBtn) {
            resetAllBtn.addEventListener('click', handleResetAll);
        }

        // Close reset modal on overlay click
        if (resetModalOverlay) {
            resetModalOverlay.addEventListener('click', (e) => {
                if (e.target === resetModalOverlay) {
                    resetModalOverlay.classList.remove('active');
                }
            });
        }
         console.log('Listeners set up.');
    }
    
    // --- User Handling & Storage ---
    function handleOnboardingSubmit(event) {
        event.preventDefault();
        
        const enteredName = userNameInput.value.trim();
        const enteredHeight = parseFloat(document.getElementById('user-height').value) || 0;
        const enteredNeck = parseFloat(document.getElementById('user-neck').value) || 0;
        const enteredWaist = parseFloat(document.getElementById('user-waist').value) || 0;
        const enteredHip = userGender === 'female' ? (parseFloat(document.getElementById('user-hip').value) || 0) : 0;
        
        // Validate only the name field is required
        let isValid = true;
        let invalidFields = [];
        
        if (!enteredName) {
            userNameInput.style.border = '1px solid var(--danger)';
            isValid = false;
            invalidFields.push('name');
        }
        
        // Reset any previous validation styling
        document.getElementById('user-height').style.border = '';
        document.getElementById('user-neck').style.border = '';
        document.getElementById('user-waist').style.border = '';
        if (userGender === 'female') {
            document.getElementById('user-hip').style.border = '';
        }
        
        if (isValid) {
            userName = enteredName;
            startDate = new Date(); // Set challenge start date
            startDate.setHours(0, 0, 0, 0); // Normalize start date
            completedDays = []; // Reset progress for new user
            gymDays = [];
            
            // Store body fat measurements
            userHeight = enteredHeight;
            userNeck = enteredNeck;
            userWaist = enteredWaist;
            userHip = enteredHip;
            
            // Only calculate body fat if all required measurements are provided
            if (enteredHeight > 0 && enteredNeck > 0 && enteredWaist > 0 && (userGender !== 'female' || enteredHip > 0)) {
                userBodyFat = calculateBodyFat(userGender, userHeight, userNeck, userWaist, userHip);
            } else {
                userBodyFat = 0; // Default if measurements are incomplete
            }
            
            saveUserData();
            showUserWelcome();
            hideOnboarding();
            initializeChallengeView(); 
            updateBodyFatDisplay();
            console.log(`User ${userName} onboarded. Start Date: ${startDate}, Body Fat: ${userBodyFat}%`);
        } else {
            console.warn(`Invalid form submission. Invalid fields: ${invalidFields.join(', ')}`);
        }
    }
    
    function saveUserData() {
        // Save all relevant state
        try {
            const dataToSave = {
                 userName: userName,
                 startDate: startDate ? startDate.toISOString() : null,
                 completedDays: completedDays,
                 gymDays: gymDays,
                 challengeCompletions: challengeCompletions, // Total
                 trophies: trophies, // Array of trophy data
                 // Body Fat data
                 userGender: userGender,
                 userHeight: userHeight,
                 userNeck: userNeck,
                 userWaist: userWaist,
                 userHip: userHip,
                 userBodyFat: userBodyFat
             };
            localStorage.setItem('fitChallengeUserProgress', JSON.stringify(dataToSave));
             console.log('User progress saved:', dataToSave);
        } catch (e) {
            console.error('Failed to save user progress:', e);
        }
    }
    
    function loadUserData() {
        // Load all relevant state
        try {
            const savedData = localStorage.getItem('fitChallengeUserProgress');
            if (savedData) {
                const data = JSON.parse(savedData);
                userName = data.userName || null;
                startDate = data.startDate ? new Date(data.startDate) : null;
                completedDays = Array.isArray(data.completedDays) ? data.completedDays : [];
                gymDays = Array.isArray(data.gymDays) ? data.gymDays : [];
                challengeCompletions = data.challengeCompletions || 0; // Load completions
                trophies = Array.isArray(data.trophies) ? data.trophies : []; // Load trophies
                // Load Body Fat data
                userGender = data.userGender || 'male';
                userHeight = data.userHeight || 0;
                userNeck = data.userNeck || 0;
                userWaist = data.userWaist || 0;
                userHip = data.userHip || 0;
                userBodyFat = data.userBodyFat || 0;
                console.log('User progress loaded.');
            } else {
                 console.log('No user progress found in storage.');
            }
        } catch (e) {
            console.error('Failed to load user progress:', e);
            // Reset state on error to avoid issues
            userName = null; 
            startDate = null;
            completedDays = [];
            gymDays = [];
            challengeCompletions = 0;
            trophies = [];
            userGender = 'male';
            userHeight = 0;
            userNeck = 0;
            userWaist = 0;
            userHip = 0;
            userBodyFat = 0;
        }
    }
    
    // --- UI Updates ---
    function showUserWelcome() {
        if (userName && userWelcome && headerUserName) {
            console.log('Updating welcome UI with username:', userName);
            
            // Update the username text without removing click functionality
            headerUserName.textContent = userName;
            
            // Clear previous content
            while (headerUserName.nextSibling) {
                headerUserName.parentNode.removeChild(headerUserName.nextSibling);
            }
            
            // Only show body fat info if it has been calculated
            if (userBodyFat && userBodyFat > 0) {
                const bodyFatInfo = getBodyFatCategory(userGender, userBodyFat);
                const bodyFatText = ` (${userBodyFat}% Body Fat - ${bodyFatInfo.category})`;
                
                // Create a span for the body fat info
                const bodyFatSpan = document.createElement('span');
                bodyFatSpan.textContent = bodyFatText;
                bodyFatSpan.className = `body-fat-display bodyfat-value-${bodyFatInfo.class}`;
                bodyFatSpan.style.fontSize = '0.8rem';
                bodyFatSpan.style.marginLeft = '5px';
                bodyFatSpan.style.color = 'var(--black)';
                
                // Add body fat info after the username
                headerUserName.parentNode.appendChild(bodyFatSpan);
            }
            
            userWelcome.style.display = 'flex';
            if(loginPrompt) loginPrompt.style.display = 'none';
            
            // Re-setup profile edit after UI update to ensure clickability
            setTimeout(setupProfileEdit, 10);
        }
    }
    
    function setupBodyFatFormInteractions() {
        // Gender selection
        const maleBtn = document.getElementById('male-gender-btn');
        const femaleBtn = document.getElementById('female-gender-btn');
        const hipInputGroup = document.getElementById('hip-input-group');
        
        if (maleBtn && femaleBtn && hipInputGroup) {
            maleBtn.addEventListener('click', () => {
                userGender = 'male';
                maleBtn.classList.add('gender-btn-active');
                femaleBtn.classList.remove('gender-btn-active');
                maleBtn.style.background = 'var(--primary)';
                maleBtn.style.color = 'white';
                maleBtn.style.borderColor = 'var(--primary)';
                femaleBtn.style.background = '#f8f9fa';
                femaleBtn.style.color = 'var(--text-primary)';
                femaleBtn.style.borderColor = '#ccc';
                hipInputGroup.style.display = 'none';
            });
            
            femaleBtn.addEventListener('click', () => {
                userGender = 'female';
                femaleBtn.classList.add('gender-btn-active');
                maleBtn.classList.remove('gender-btn-active');
                femaleBtn.style.background = 'var(--primary)';
                femaleBtn.style.color = 'white';
                femaleBtn.style.borderColor = 'var(--primary)';
                maleBtn.style.background = '#f8f9fa';
                maleBtn.style.color = 'var(--text-primary)';
                maleBtn.style.borderColor = '#ccc';
                hipInputGroup.style.display = 'block';
            });
        }
        
        // Info buttons toggling
        const setupInfoButton = (btnId, infoId) => {
            const btn = document.getElementById(btnId);
            const info = document.getElementById(infoId);
            if (btn && info) {
                btn.addEventListener('click', () => {
                    info.style.display = info.style.display === 'none' ? 'block' : 'none';
                });
            }
        };
        
        setupInfoButton('neck-info-btn', 'neck-info');
        setupInfoButton('waist-info-btn', 'waist-info');
        setupInfoButton('hip-info-btn', 'hip-info');
        
        // Reset validation styling on input
        const inputFields = ['user-name', 'user-height', 'user-neck', 'user-waist', 'user-hip'];
        inputFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', () => {
                    field.style.border = '1px solid #ccc';
                });
            }
        });
    }
    
    // --- Challenge App Initialization ---
    function initializeChallengeView() {
        console.log('Initializing challenge view...');
        
        // Show challenge container
        if (challengeAppContainer) {
            challengeAppContainer.style.display = 'block';
            
            // Add scroll animation for showing challenge container
            challengeAppContainer.style.opacity = '0';
            challengeAppContainer.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                challengeAppContainer.style.transition = 'all 0.5s ease';
                challengeAppContainer.style.opacity = '1';
                challengeAppContainer.style.transform = 'translateY(0)';
            }, 100);
        }
        updateCalendar();
        updateBodyFatDisplay(); // Update Body Fat display
        updateStats(); // Update stats after initializing
        updateTrophyCabinet();
    }
    
    // --- Calendar Logic ---
function updateCalendar() {
        if (!calendarDates || !currentMonthElement) return;
        console.log(`Updating calendar for ${monthNames[currentDisplayMonth]} ${currentDisplayYear}`);

        calendarDates.innerHTML = '';
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const firstDayOfMonth = new Date(currentDisplayYear, currentDisplayMonth, 1);
        const daysInMonth = new Date(currentDisplayYear, currentDisplayMonth + 1, 0).getDate();
        const startingDayOfWeek = firstDayOfMonth.getDay(); 

        currentMonthElement.textContent = `${monthNames[currentDisplayMonth]} ${currentDisplayYear}`;

        // Add empty cells for days before the first day of the month
        for (let i = 0; i < startingDayOfWeek; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('date-cell', 'empty');
            calendarDates.appendChild(emptyCell);
        }
        
        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement('div');
            cell.classList.add('date-cell');
            
            // Add date number
            const dateNumber = document.createElement('span');
            dateNumber.textContent = day;
            cell.appendChild(dateNumber);
            
            // Add status icon container
            const statusIcon = document.createElement('span');
            statusIcon.classList.add('date-status');
            statusIcon.innerHTML = '<i class="fas fa-check"></i>';
            cell.appendChild(statusIcon);
            
            const currentDate = new Date(currentDisplayYear, currentDisplayMonth, day);
            currentDate.setHours(0,0,0,0);
            const dateString = currentDate.toISOString().split('T')[0];
            
            // Calculate challenge day number
            const challengeDayNum = startDate ? Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24)) + 1 : -1;
            const isChallengeDay = challengeDayNum > 0 && challengeDayNum <= 30;
            
            // Add appropriate classes
            if (currentDate.getTime() === today.getTime()) {
                cell.classList.add('current-day');
            }
            
            // Marcar días de entrenamiento en casa como completados 
            if (completedDays.includes(dateString)) {
                cell.classList.add('completed');
            }
            
            // Mantener la marca de gimnasio separada
            if (gymDays.includes(dateString)) {
                cell.classList.add('gym-day');
                const gymMarker = document.createElement('span');
                gymMarker.classList.add('gym-marker');
                gymMarker.innerHTML = '<i class="fas fa-dumbbell"></i>';
                cell.appendChild(gymMarker);
            }
            
            // Add click event only for valid challenge days
            if (startDate && isChallengeDay) {
                cell.addEventListener('click', () => {
                    console.log('Cell clicked:', dateString, challengeDayNum);
                    openDayModal(dateString, challengeDayNum);
                });
                cell.style.cursor = 'pointer';
            } else {
                cell.classList.add('disabled');
            }

            calendarDates.appendChild(cell);
        }
    }

    function navigateMonth(direction) {
        currentDisplayMonth += direction;
        if (currentDisplayMonth > 11) {
            currentDisplayMonth = 0;
            currentDisplayYear++;
        } else if (currentDisplayMonth < 0) {
            currentDisplayMonth = 11;
            currentDisplayYear--;
        }
        updateCalendar();
    }
    
    // --- Day Modal Logic ---
    function openDayModal(dateString, challengeDayNum) {
        console.log(`Attempting to open modal for ${dateString} (Challenge Day: ${challengeDayNum})`);

        if (!dayModalOverlay || !dayModalTitle || !workoutListContainer || !dayModalSubtitle || !workoutQuestionActions || !completedMessageActions) {
            console.error('Modal elements missing! Cannot open modal.');
            return;
        }

        selectedDateString = dateString;
        const dayIndex = challengeDayNum - 1;
        const dayData = (dayIndex >= 0 && dayIndex < challengeData.length) ? challengeData[dayIndex] : { title: 'Rest Day', exercises: [] }; // Handle missing day data gracefully
        
        const isCompleted = completedDays.includes(dateString);
        const isGymDay = gymDays.includes(dateString);

        // Update modal title and subtitle
        dayModalTitle.textContent = `Day ${challengeDayNum}`;
        dayModalSubtitle.textContent = dayData.title || "Today's Workout"; 

        // Clear previous workout list content
        workoutListContainer.innerHTML = '';
        
        // Reset UI state
        workoutInfoContainer.style.display = 'none';
        btnMarkComplete.style.display = 'none';
        
        // Set initial button states
        btnHomeWorkout.classList.remove('btn-secondary');
        btnHomeWorkout.classList.add('btn-primary');
        btnGym.classList.remove('btn-primary');
        btnGym.classList.add('btn-secondary');

        // If day is already completed/marked, show completion view
        if (isCompleted || isGymDay) {
            workoutQuestionActions.style.display = 'none';
            completedMessageActions.style.display = 'flex';
            
            // Update completion status text
            dayModalSubtitle.textContent = isCompleted ? 'Home Workout Completed' : 'Gym Day Completed'; 
            if (completionStatusText) completionStatusText.textContent = isCompleted ? 'Challenge Workout Completed!' : 'Gym Day Recorded!';
            
            // Optionally display the completed workout if needed
            if (isCompleted && dayData && dayData.exercises && dayData.exercises.length > 0) {
                workoutInfoContainer.style.display = 'block';
                dayData.exercises.forEach((ex) => {
                    const item = document.createElement('div');
                    item.className = 'exercise-item completed-view'; // Add a class for styling completed view if needed
                    item.innerHTML = `
                        <div class="exercise-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="exercise-details">
                            <div class="exercise-name">${ex.name}</div>
                            <div class="exercise-reps">${ex.reps}</div>
                        </div>
                    `;
                    workoutListContainer.appendChild(item);
                });
            } else {
                workoutListContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No specific exercises listed for this completed day.</p>';
            }
        } else {
            // Fresh day, show workout selection
            workoutQuestionActions.style.display = 'flex';
            completedMessageActions.style.display = 'none';
            
            // Create exercises list (but don't show until home workout selected)
            if (dayData && dayData.exercises && dayData.exercises.length > 0) {
                dayData.exercises.forEach((ex, index) => {
                    const item = document.createElement('div');
                    item.className = 'exercise-item';
                    item.dataset.id = `ex-${index}`;
                    item.innerHTML = `
                        <div class="exercise-icon"><i class="fas fa-dumbbell"></i></div>
                        <div class="exercise-details">
                            <div class="exercise-name">${ex.name}</div>
                            <div class="exercise-reps">${ex.reps}</div>
                        </div>
                        <div class="exercise-check"><i class="fas fa-check"></i></div>
                    `;
                    
                    // إضافة تفاعلية للتمارين
                    item.addEventListener('click', function() {
                        this.classList.toggle('completed');
                        const checkIcon = this.querySelector('.exercise-check');
                        if (this.classList.contains('completed')) {
                            checkIcon.style.opacity = '1';
                        } else {
                            checkIcon.style.opacity = '0';
                        }
                    });
                    
                    workoutListContainer.appendChild(item);
                });
            } else {
                workoutListContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No specific exercises for today.</p>';
            }
        }

        dayModalOverlay.classList.add('active');
        console.log(`Modal activated for ${dateString}`);
    }

    function handleHomeWorkout() {
        console.log('Home workout selected');
        
        if (!selectedDateString) return;
        
        // Update button states to show active selection
        btnHomeWorkout.classList.remove('btn-secondary');
        btnHomeWorkout.classList.add('btn-primary');
        btnGym.classList.remove('btn-primary');
        btnGym.classList.add('btn-secondary');
        
        // Show workout details container
        if (workoutInfoContainer) {
            workoutInfoContainer.style.display = 'block';
        }
        
        // Show mark complete button
        if (btnMarkComplete) {
            btnMarkComplete.style.display = 'block';
        }
    }

    function handleGymVisitMark() {
        console.log('Gym workout selected');
        
        if (!selectedDateString) return;
        
        // Update button states to show active selection
        btnGym.classList.remove('btn-secondary');
        btnGym.classList.add('btn-primary');
        btnHomeWorkout.classList.remove('btn-primary');
        btnHomeWorkout.classList.add('btn-secondary');
        
        // Hide workout details since gym workouts don't have predefined exercises
        if (workoutInfoContainer) {
            workoutInfoContainer.style.display = 'none';
        }
        
        // Show mark complete button
        if (btnMarkComplete) {
            btnMarkComplete.style.display = 'block';
        }
        
        // Or mark gym day immediately if preferred
        // handleGymDayComplete();
    }
    
    function handleGymDayComplete() {
        if (!selectedDateString) return;
        
        // Allow re-marking if it was previously a challenge day
        if (gymDays.includes(selectedDateString)) {
            console.log('Day already marked as gym day.');
            closeDayModal(); // Close modal if already marked this way
            return;
        }
        
        // Remove from completed days if it was marked as such
        completedDays = completedDays.filter(d => d !== selectedDateString);
        
        // Add to gym days
        if (!gymDays.includes(selectedDateString)) {
            gymDays.push(selectedDateString);
            gymDays.sort();
        }
        
        console.log(`Marking ${selectedDateString} as gym day.`);
        saveUserData();
        updateCalendar();
        updateStats();
        
        // Update modal immediately to show completion without closing
        if (workoutQuestionActions) workoutQuestionActions.style.display = 'none';
        if (completedMessageActions) completedMessageActions.style.display = 'flex';
        if (dayModalSubtitle) dayModalSubtitle.textContent = 'Gym Day Completed';
        if (completionStatusText) completionStatusText.textContent = 'Gym Day Recorded!';
    }

    function handleWorkoutComplete() {
        if (!selectedDateString) return;
        
        // Check which workout type is selected
        const isGymSelected = btnGym.classList.contains('btn-primary');
        
        if (isGymSelected) {
            handleGymDayComplete();
            return;
        }
        
        // Handle home workout completion
        if (completedDays.includes(selectedDateString)) {
            console.log('Day already marked as challenge complete.');
            closeDayModal(); // Close modal if already marked this way
            return;
        }
        
        // Remove from gym days if it was marked as such
        gymDays = gymDays.filter(d => d !== selectedDateString);
        
        // Add to completed days
        if (!completedDays.includes(selectedDateString)) {
            completedDays.push(selectedDateString);
            completedDays.sort();
        }
        
        console.log(`Marking ${selectedDateString} as challenge complete.`);
        saveUserData();
        updateCalendar();
        updateStats();
        
        // Update modal immediately to show completion without closing
        if (workoutQuestionActions) workoutQuestionActions.style.display = 'none';
        if (completedMessageActions) completedMessageActions.style.display = 'flex';
        if (dayModalSubtitle) dayModalSubtitle.textContent = 'Home Workout Completed';
        if (completionStatusText) completionStatusText.textContent = 'Challenge Workout Completed!';
    }

    function handleResetDay() {
        if (!selectedDateString) return;
        
        console.log(`Removing workout status for ${selectedDateString}`);
        
        // Remove from both completed days and gym days
        completedDays = completedDays.filter(d => d !== selectedDateString);
        gymDays = gymDays.filter(d => d !== selectedDateString);
        
        saveUserData();
        updateCalendar();
        updateStats();
        
        // Update modal to show the workout options again
        if (workoutQuestionActions) workoutQuestionActions.style.display = 'flex';
        if (completedMessageActions) completedMessageActions.style.display = 'none';
        if (dayModalSubtitle) dayModalSubtitle.textContent = 'Choose your activity';
        
        // Show a brief confirmation
        const flashMessage = document.createElement('div');
        flashMessage.textContent = 'Workout canceled for this day';
        flashMessage.style.position = 'fixed';
        flashMessage.style.bottom = '20px';
        flashMessage.style.left = '50%';
        flashMessage.style.transform = 'translateX(-50%)';
        flashMessage.style.backgroundColor = 'var(--warning)';
        flashMessage.style.color = 'white';
        flashMessage.style.padding = '10px 20px';
        flashMessage.style.borderRadius = '5px';
        flashMessage.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
        flashMessage.style.zIndex = '9999';
        
        document.body.appendChild(flashMessage);
        
        // Remove the flash message after 3 seconds
        setTimeout(() => {
            if (flashMessage.parentNode) {
                flashMessage.parentNode.removeChild(flashMessage);
            }
        }, 3000);
    }

    function closeDayModal() {
         console.log("Closing day modal");
         if (dayModalOverlay) {
             dayModalOverlay.classList.remove('active');
         }
         selectedDateString = null; // Clear selected date
     }
     
     function setupDayModalListeners() {
        const homeWorkout = document.getElementById('home-workout');
        const gymWorkout = document.getElementById('gym-workout');
        const workoutInfo = document.querySelector('.workout-info');
        const btnMarkComplete = document.getElementById('btn-mark-complete');
        const workoutSummary = document.getElementById('workout-summary');

        if (homeWorkout) {
            homeWorkout.addEventListener('click', () => {
                selectedWorkoutType = 'home';
                homeWorkout.classList.add('selected');
                gymWorkout.classList.remove('selected');
                workoutInfo.style.display = 'block';
                workoutSummary.classList.add('show');
                btnMarkComplete.style.display = 'block';
                completedExercises.clear();
                updateWorkoutSummary();
            });
        }

        if (gymWorkout) {
            gymWorkout.addEventListener('click', () => {
                selectedWorkoutType = 'gym';
                gymWorkout.classList.add('selected');
                homeWorkout.classList.remove('selected');
                workoutInfo.style.display = 'none';
                workoutSummary.classList.remove('show');
                btnMarkComplete.style.display = 'block';
            });
        }
    }

    function updateWorkoutSummary() {
        const totalExercises = document.querySelectorAll('.exercise-item').length;
        const completedCount = completedExercises.size;
        const progress = totalExercises > 0 ? Math.round((completedCount / totalExercises) * 100) : 0;
        
        document.getElementById('completed-exercises').textContent = `${completedCount}/${totalExercises}`;
        document.getElementById('exercise-progress').textContent = `${progress}%`;
    }

    function toggleExerciseComplete(exerciseElement) {
        const exerciseId = exerciseElement.dataset.id;
        if (exerciseElement.classList.contains('completed')) {
            exerciseElement.classList.remove('completed');
            completedExercises.delete(exerciseId);
        } else {
            exerciseElement.classList.add('completed');
            completedExercises.add(exerciseId);
        }
        updateWorkoutSummary();
    }

    // --- Stats Logic ---
    function updateStats() {
        const gymDaysElement = document.getElementById('gym-days');
        
        // Comprobar individualmente cada elemento para generar advertencias más específicas
        if (!activeDaysElement) {
            console.warn("activeDaysElement not found, skipping update.");
        }
        if (!daysLeftElement) {
            console.warn("daysLeftElement not found, skipping update.");
        }
        if (!gymDaysElement) {
            console.warn("gymDaysElement not found, skipping update.");
        }
        
        // Continuar incluso si falta algún elemento
        const totalActiveDays = [...new Set([...completedDays, ...gymDays])].length;
        const daysLeftCount = Math.max(0, 30 - totalActiveDays);
        const progress = totalActiveDays >= 30 ? 100 : (totalActiveDays / 30) * 100;
        const gymDaysCount = gymDays.length;
        
        // Update DOM
        if (activeDaysElement) activeDaysElement.textContent = totalActiveDays;
        if (daysLeftElement) daysLeftElement.textContent = daysLeftCount;
        if (gymDaysElement) {
            gymDaysElement.textContent = gymDaysCount;
            // Mantener oculta la tarjeta de estadísticas de gimnasio
            const gymStatCard = gymDaysElement.closest('.stat-card');
            if (gymStatCard) {
                gymStatCard.style.display = 'none';
            }
        }
        
        if (progressFill) progressFill.style.width = `${progress}%`;
        if (progressPercentage) progressPercentage.textContent = `${Math.round(progress)}%`;
        
        console.log(`Stats updated: Active=${totalActiveDays}, Left=${daysLeftCount}, Gym=${gymDaysCount}, Progress=${progress}%`);
        
        // Check for challenge completion
        if (totalActiveDays >= 30 && daysLeftCount === 0) {
            const existingTrophy = trophies.find(trophy => 
                trophy.month === currentDisplayMonth && trophy.year === currentDisplayYear
            );
            
            if (!existingTrophy) {
                // Add new trophy for current month if not exists
                trophies.push({
                    month: currentDisplayMonth,
                    year: currentDisplayYear,
                    date: new Date().toISOString()
                });
                challengeCompletions = trophies.length; // Update completion count
                saveUserData();
                updateTrophyCabinet();
                showChallengeCompletionModal(challengeCompletions);
            }
        }
    }

    function updateTrophyCabinet() {
        const trophiesGrid = document.getElementById('trophies-grid');
        if (!trophiesGrid) return;

        trophiesGrid.innerHTML = '';

        if (trophies.length > 0) {
            trophies.forEach((trophy, index) => {
                const trophyItem = document.createElement('div');
                trophyItem.className = 'trophy-item';
                
                // Get year for display
                const year = trophy.year;
                
                trophyItem.innerHTML = `
                    <div class="trophy-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="trophy-year">${year}</div>
                `;
                trophiesGrid.appendChild(trophyItem);
            });
        } else {
            trophiesGrid.innerHTML = `
                <div class="no-trophies-message">
                    Complete the 30-day challenge to earn your first trophy!
                </div>
            `;
        }
    }

    function showChallengeCompletionModal(completionCount) {
        const modal = document.getElementById('achievement-modal');
        const completionNumber = document.getElementById('completion-number');
        if (!modal || !completionNumber) return;

        const suffix = getOrdinalSuffix(completionCount);
        completionNumber.textContent = `${completionCount}${suffix}`;
        
        modal.classList.add('active');
        
        const startNewBtn = document.getElementById('start-new-challenge');
        if (startNewBtn) {
            startNewBtn.onclick = () => {
                completedDays = [];
                gymDays = [];
                startDate = new Date();
                startDate.setHours(0, 0, 0, 0);
                saveUserData();
                updateCalendar();
                updateStats();
                modal.classList.remove('active');
            };
        }
    }
    
    function getOrdinalSuffix(num) {
        const j = num % 10,
              k = num % 100;
        if (j == 1 && k != 11) {
            return "st";
        }
        if (j == 2 && k != 12) {
            return "nd";
        }
        if (j == 3 && k != 13) {
            return "rd";
        }
        return "th";
    }

    function handleResetMonth() {
        if (confirm('Are you sure you want to reset all progress for the current month? This will also remove any trophy earned for this month.')) {
            // Use the displayed month instead of the current system month
            const monthToReset = currentDisplayMonth;
            const yearToReset = currentDisplayYear;
            
            // Filter out completed days from displayed month
            completedDays = completedDays.filter(dateStr => {
                const date = new Date(dateStr);
                return date.getMonth() !== monthToReset || date.getFullYear() !== yearToReset;
            });
            
            // Filter out gym days from displayed month
            gymDays = gymDays.filter(dateStr => {
                const date = new Date(dateStr);
                return date.getMonth() !== monthToReset || date.getFullYear() !== yearToReset;
            });
            
            // Filter out trophy for this month if exists
            trophies = trophies.filter(trophy => 
                trophy.month !== monthToReset || trophy.year !== yearToReset
            );
            
            // Update challenge completions count
            challengeCompletions = trophies.length;
            
            saveUserData();
            updateCalendar();
            updateStats();
            updateTrophyCabinet();
            
            const resetModal = document.getElementById('reset-modal');
            if (resetModal) resetModal.classList.remove('active');
            
            console.log(`Reset completed for ${monthNames[monthToReset]} ${yearToReset}`);
        }
    }

    function handleResetAll() {
        if (confirm('Are you sure you want to reset ALL challenge progress? This will require you to enter your name again and remove all earned trophies.')) {
            // Clear all data
            localStorage.removeItem('fitChallengeUserProgress');
            userName = null;
            startDate = null;
            completedDays = [];
            gymDays = [];
            challengeCompletions = 0;
            trophies = []; // Clear all trophies
            
            // Hide challenge view
            if (challengeAppContainer) {
                challengeAppContainer.style.display = 'none';
            }
            
            // Show onboarding
            showOnboarding();
            
            // Reset UI
            const resetModal = document.getElementById('reset-modal');
            if (resetModal) resetModal.classList.remove('active');
            if (userWelcome) userWelcome.style.display = 'none';
        }
    }

    // --- Run Initialization ---
document.addEventListener('DOMContentLoaded', init);

    // --- Body Fat Functions ---
    function calculateBodyFat(gender, height, neck, waist, hip) {
        // US Army Body Fat Formula
        let bodyFat = 0;
        
        // All measurements should be in cm
        if (gender === 'male') {
            // Male Formula: 86.010 × log₁₀(waist - neck) - 70.041 × log₁₀(height) + 36.76
            bodyFat = 86.010 * Math.log10(waist - neck) - 70.041 * Math.log10(height) + 36.76;
        } else {
            // Female Formula: 163.205 × log₁₀(waist + hip - neck) - 97.684 × log₁₀(height) - 78.387
            bodyFat = 163.205 * Math.log10(waist + hip - neck) - 97.684 * Math.log10(height) - 78.387;
        }
        
        // Ensure result is positive and not above 100%
        bodyFat = Math.max(0, Math.min(bodyFat, 100));
        return parseFloat(bodyFat.toFixed(1));
    }
    
    function getBodyFatCategory(gender, bodyFat) {
        if (gender === 'male') {
            if (bodyFat < 8) return { category: 'Athletic', class: 'athletic' };
            else if (bodyFat < 15) return { category: 'Fitness', class: 'fitness' };
            else if (bodyFat < 25) return { category: 'Average', class: 'average' };
            else return { category: 'Obese', class: 'obese' };
        } else {
            if (bodyFat < 15) return { category: 'Athletic', class: 'athletic' };
            else if (bodyFat < 23) return { category: 'Fitness', class: 'fitness' };
            else if (bodyFat < 32) return { category: 'Average', class: 'average' };
            else return { category: 'Obese', class: 'obese' };
        }
    }
    
    function updateBodyFatDisplay() {
        const bodyFatValue = document.getElementById('bodyfat-value');
        const bodyFatCategory = document.getElementById('bodyfat-category');
        const bodyFatIndicator = document.getElementById('bodyfat-indicator');
        const bodyFatProgressFill = document.getElementById('bodyfat-progress-fill');
        
        if (!bodyFatValue || !bodyFatCategory || !bodyFatIndicator || !bodyFatProgressFill) {
            console.warn('Body Fat elements not found or Body Fat not calculated');
            return;
        }
        
        // Handle case when body fat is not calculated (due to missing measurements)
        if (!userBodyFat || userBodyFat <= 0) {
            bodyFatValue.textContent = 'N/A';
            bodyFatCategory.textContent = 'No Data';
            bodyFatIndicator.style.left = '0%';
            bodyFatProgressFill.style.width = '0%';
            return;
        }
        
        const bodyFatInfo = getBodyFatCategory(userGender, userBodyFat);
        
        // Update Body Fat Value
        bodyFatValue.textContent = `${userBodyFat}%`;
        bodyFatValue.className = `stat-value bodyfat-value-${bodyFatInfo.class}`;
        
        // Update Body Fat Category
        bodyFatCategory.textContent = bodyFatInfo.category;
        
        // Convert Body Fat to percentage for positioning
        // Male range: 4-40%, Female range: 10-50%
        let position = 0;
        const minValue = userGender === 'male' ? 4 : 10;
        const maxValue = userGender === 'male' ? 40 : 50;
        const range = maxValue - minValue;
        
        if (userBodyFat < minValue) position = 0;
        else if (userBodyFat > maxValue) position = 100;
        else position = ((userBodyFat - minValue) / range) * 100;
        
        // Update progress fill
        bodyFatProgressFill.style.width = `${position}%`;
        
        // Update indicator position
        bodyFatIndicator.style.left = `${position}%`;
        
        // Add pulse animation
        bodyFatIndicator.classList.remove('pulse');
        void bodyFatIndicator.offsetWidth; // Trigger reflow
        bodyFatIndicator.classList.add('pulse');
        
        console.log(`Body Fat Display updated: ${userBodyFat}% (${bodyFatInfo.category}), Position: ${position}%`);
    }
    
    // Profile Edit Functions
    function setupProfileEdit() {
        console.log('Setting up profile edit feature...');
        const headerUserName = document.getElementById('header-user-name');
        
        if (headerUserName) {
            console.log('Found username element:', headerUserName.textContent);
            
            // Make sure it's clickable
            headerUserName.style.cursor = 'pointer';
            headerUserName.title = 'Click to edit your profile';
            
            // Remove any existing click handlers to avoid duplicates
            headerUserName.removeEventListener('click', openProfileEditModal);
            
            // Add click event listener
            headerUserName.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Username clicked! Opening edit modal...');
                openProfileEditModal();
            });
            
            console.log('Click handler attached successfully');
        } else {
            console.error('Username element not found! Make sure header-user-name exists in the DOM');
        }
    }
    
    function openProfileEditModal() {
        const onboardingOverlay = document.getElementById('onboarding-overlay');
        const onboardingTitle = document.getElementById('onboarding-title');
        const onboardingMessage = document.getElementById('onboarding-message');
        const startBtn = document.getElementById('start-btn');
        const userNameInput = document.getElementById('user-name');
        const userHeightInput = document.getElementById('user-height');
        const userNeckInput = document.getElementById('user-neck');
        const userWaistInput = document.getElementById('user-waist');
        const userHipInput = document.getElementById('user-hip');
        const maleBtn = document.getElementById('male-gender-btn');
        const femaleBtn = document.getElementById('female-gender-btn');
        
        if (!onboardingOverlay) return;
        
        // Change titles for editing mode
        if (onboardingTitle) onboardingTitle.textContent = 'Edit Your Profile';
        if (onboardingMessage) onboardingMessage.textContent = 'Update your personal information here';
        if (startBtn) startBtn.textContent = 'Save Changes';
        
        // Fill with current data
        if (userNameInput) userNameInput.value = userName || '';
        if (userHeightInput) userHeightInput.value = userHeight || '';
        if (userNeckInput) userNeckInput.value = userNeck || '';
        if (userWaistInput) userWaistInput.value = userWaist || '';
        if (userHipInput) userHipInput.value = userHip || '';
        
        // Set current gender
        if (userGender === 'male' && maleBtn) {
            maleBtn.click();
        } else if (userGender === 'female' && femaleBtn) {
            femaleBtn.click();
        }
        
        // Change form handler
        const onboardingForm = document.getElementById('onboarding-form');
        if (onboardingForm) {
            // Store original handler to restore later
            const originalHandler = onboardingForm.onsubmit;
            onboardingForm.onsubmit = null;
            
            // Use profile update handler
            onboardingForm.removeEventListener('submit', handleOnboardingSubmit);
            onboardingForm.addEventListener('submit', function(event) {
                handleProfileUpdate(event, originalHandler);
            });
        }
        
        // Show the modal
        onboardingOverlay.classList.add('active');
    }
    
    function handleProfileUpdate(event, originalHandler) {
        event.preventDefault();
        
        const enteredName = document.getElementById('user-name').value.trim();
        const enteredHeight = parseFloat(document.getElementById('user-height').value) || 0;
        const enteredNeck = parseFloat(document.getElementById('user-neck').value) || 0;
        const enteredWaist = parseFloat(document.getElementById('user-waist').value) || 0;
        const enteredHip = userGender === 'female' ? (parseFloat(document.getElementById('user-hip').value) || 0) : 0;
        
        // Validate inputs - only name is required
        let isValid = true;
        let invalidFields = [];
        
        if (!enteredName) {
            document.getElementById('user-name').style.border = '1px solid var(--danger)';
            isValid = false;
            invalidFields.push('name');
        }
        
        // Reset any previous validation styling
        document.getElementById('user-height').style.border = '';
        document.getElementById('user-neck').style.border = '';
        document.getElementById('user-waist').style.border = '';
        if (userGender === 'female') {
            document.getElementById('user-hip').style.border = '';
        }
        
        if (isValid) {
            // Update user data
            userName = enteredName;
            userHeight = enteredHeight;
            userNeck = enteredNeck;
            userWaist = enteredWaist;
            userHip = enteredHip;
            
            // Only calculate body fat if all required measurements are provided
            if (enteredHeight > 0 && enteredNeck > 0 && enteredWaist > 0 && (userGender !== 'female' || enteredHip > 0)) {
                userBodyFat = calculateBodyFat(userGender, userHeight, userNeck, userWaist, userHip);
            } else {
                userBodyFat = 0; // Default if measurements are incomplete
            }
            
            // Save and update UI
            saveUserData();
            showUserWelcome();
            updateBodyFatDisplay();
            
            // Close modal
            const onboardingOverlay = document.getElementById('onboarding-overlay');
            if (onboardingOverlay) {
                onboardingOverlay.classList.remove('active');
            }
            
            // Restore original form handler
            const onboardingForm = document.getElementById('onboarding-form');
            if (onboardingForm) {
                onboardingForm.onsubmit = null;
                onboardingForm.removeEventListener('submit', handleProfileUpdate);
                onboardingForm.addEventListener('submit', handleOnboardingSubmit);
            }
            
            // Show success message
            showNotification('Profile updated successfully');
            
            console.log(`User profile updated: ${userName}, Body Fat: ${userBodyFat}%`);
        } else {
            console.warn(`Invalid form submission. Invalid fields: ${invalidFields.join(', ')}`);
        }
    }
    
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.left = '50%';
        notification.style.transform = 'translateX(-50%)';
        notification.style.backgroundColor = 'var(--success)';
        notification.style.color = 'white';
        notification.style.padding = '10px 20px';
        notification.style.borderRadius = '5px';
        notification.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
        notification.style.zIndex = '9999';
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s ease';
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    // Initialize profile edit functionality when the app loads
    document.addEventListener('DOMContentLoaded', function() {
        // Add a small delay to ensure the DOM is fully loaded and other init functions have completed
        setTimeout(function() {
            setupProfileEdit();
            console.log('Profile edit functionality initialized');
        }, 100);
    });
</script>
</body>
</html>
